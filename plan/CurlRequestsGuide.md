# План и примеры curl‑запросов

Ниже — примерный сценарий и конкретные `curl`‑команды для:

1. Создания холда.
2. Повторного запроса с тем же Idempotency-Key (идемпотентность).
3. Подтверждения холда.
4. Отмены холда.
5. Конфликта при оверсейле (нет свободных мест).

---

## 1. Создание холда

**Цель:** создать новый hold для слота `slot_id = 1` с уникальным `Idempotency-Key`.

    curl -i -X POST "http://localhost/slots/1/hold" \
        -H "Content-Type: application/json" \
        -H "Idempotency-Key: 11111111-1111-1111-1111-111111111111"


**Разбор:**

- `-X POST` — HTTP‑метод, создание ресурса.
- `"localhost/slots/1/hold"` — маршрут создания холда для слота с ID `1`.
- `-H "Content-Type: application/json"` — формально тело не требуется, но заголовок не мешает.
- `-H "Idempotency-Key: ..."` — ключ идемпотентности:
    - При первом запросе с этим ключом система попытается создать новый hold.
    - Ожидаемый код ответа: `201 Created`.
    - Ожидаемое тело (пример):

      ```json
      {
        "id": 10,
        "slot_id": 1,
        "status": "held",
        "expires_at": "2025-11-22T10:15:30+00:00"
      }
      ```

Сохраните `id` из ответа (в примере это `10`) — он понадобится для подтверждения и отмены.

---

## 2. Повторный запрос с тем же Idempotency-Key

**Цель:** убедиться, что повторный запрос с тем же ключом возвращает тот же hold (идемпотентность).

    curl -X POST "http://localhost/slots/1/hold" \
        -H "Content-Type: application/json" \
        -H "Idempotency-Key: 11111111-1111-1111-1111-111111111111"

**Разбор:**

- Полностью тот же запрос, что и в шаге 1 (тот же slot, тот же Idempotency-Key).
- Ожидаемое поведение:
    - Не создается новый hold.
    - Возвращается ранее созданный.
    - Код ответа: обычно `200 OK` (а не `201`).
    - Тело совпадает по `id`, `slot_id`, `status`, `expires_at` с результатом из шага 1.

---

## 3. Подтверждение холда

**Цель:** подтвердить ранее созданный hold и уменьшить `remaining` у слота.

Допустим, из шага 1 вы получили `id` холда `10`.

    curl -X POST "http://localhost/holds/10/confirm" \
        -H "Content-Type: application/json"

**Разбор:**

- `POST /holds/{id}/confirm` — подтверждение конкретного холда.
- Ожидаемое поведение:
    - Статус холда меняется с `held` на `confirmed`.
    - Число доступных мест (`remaining`) в соответствующем слоте уменьшается на `1` (атомарно, с блокировкой строки).
    - Инвалидируется кеш доступных слотов.
    - Код ответа: `200 OK`.
    - Пример ответа:

      ```json
      {
        "id": 10,
        "slot_id": 1,
        "status": "confirmed",
        "expires_at": "2025-11-22T10:15:30+00:00"
      }
      ```

Если холд уже подтвержден, повторный запрос должен быть идемпотентным (вернуть тот же подтверждённый холд).

---

## 4. Отмена холда

**Цель:** отменить существующий hold, освободив место в слоте (если он уже был подтвержден).

Предположим, есть холд с `id = 11`.

    curl -X DELETE "http://localhost/holds/11" \
        -H "Content-Type: application/json"

**Разбор:**

- `DELETE /holds/{id}` — отмена конкретного холда.
- Ожидаемое поведение:
    - Статус холда становится `cancelled`.
    - Если холд был `confirmed`, `remaining` соответствующего слота увеличивается на `1`.
    - Инвалидируется кеш доступных слотов.
    - Код ответа: `200 OK`.
    - Пример ответа:

      ```json
      {
        "id": 11,
        "slot_id": 1,
        "status": "cancelled",
        "expires_at": "2025-11-22T10:20:00+00:00"
      }
      ```

Повторный `DELETE` того же холда должен быть идемпотентным (вернуть уже `cancelled` холд и `200 OK`).

---

## 5. Конфликт при оверсейле

**Цель:** смоделировать ситуацию, когда свободных мест в слоте нет (`remaining = 0`), и запрос на создание или подтверждение холда приводит к `409 Conflict`.

Есть два типовых пути:

### 5.1. Конфликт при создании нового холда

Перед этим убедитесь, что у нужного слота `remaining = 0`  
(например, через `GET /slots/availability` или через БД).

    bash curl -X POST "localhost/slots/2/hold"
        -H "Content-Type: application/json"
        -H "Idempotency-Key: 22222222-2222-2222-2222-222222222222"

**Разбор:**

- `POST /slots/2/hold` — пытаемся создать hold для слота, где больше нет мест.
- Внутри логика проверяет `remaining <= 0`.
- Ожидаемый результат:
    - Код ответа: `409 Conflict`.
    - Пример ответа (может отличаться по форме):

      ```json
      {
        "type": "conflict",
        "message": "No remaining capacity for this slot."
      }
      ```

---

### 5.2. Конфликт при подтверждении холда (оверсел при confirm)

Сценарий:

1. Есть слот с `remaining = 0` (всё разобрано другими подтверждёнными холдами).
2. У вас всё ещё есть `held`‑холд, указывающий на этот слот (например, был создан заранее, до того как места закончились).


    bash curl -X POST "localhost/holds/12/confirm"
        -H "Content-Type: application/json"

**Разбор:**

- `POST /holds/12/confirm` — пытаемся подтвердить холд, но слот уже полностью занят.
- При блокировке строки слота и проверке `remaining <= 0` ожидается:
    - Код ответа: `409 Conflict`.
    - Пример ответа:

      ```json
      {
        "type": "conflict",
        "message": "No remaining capacity to confirm this hold."
      }
      ```

---

## Резюме плана тестирования через curl

1. **Создать холд**
    - `POST /slots/1/hold` с новым `Idempotency-Key`.
    - Убедиться, что получен `201` и статус `held`.

2. **Проверить идемпотентность создания**
    - Повторить тот же `POST /slots/1/hold` с тем же `Idempotency-Key`.
    - Убедиться, что вернётся тот же `id`, `200 OK`.

3. **Подтвердить холд**
    - `POST /holds/{id}/confirm`.
    - Проверить, что статус меняется на `confirmed`, `remaining` уменьшается.

4. **Отменить холд**
    - `DELETE /holds/{id}`.
    - Проверить, что статус `cancelled`, при необходимости `remaining` увеличивается.

5. **Проверить конфликт при оверсейле**
    - Убедиться, что у нужного слота `remaining = 0`.
    - Попробовать:
        - `POST /slots/{id}/hold` — ожидаемый `409 Conflict`.
        - либо `POST /holds/{id}/confirm` для `held`‑холда по этому слоту — также `409 Conflict`.

Этот набор curl‑команд и шагов даёт полный сквозной сценарий: от нормальной работы до ошибок при отсутствии доступных мест.
